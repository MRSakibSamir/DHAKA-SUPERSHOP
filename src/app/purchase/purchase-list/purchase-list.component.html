<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Purchase Entry</h3>
    <span class="badge bg-dark">Status: {{ form.get('status')?.value }}</span>
  </div>

  <form [formGroup]="form" (ngSubmit)="onSubmit()">
    <div class="card shadow-sm rounded-4">
      <div class="card-body">
        <div class="row g-3 mb-3">
          <div class="col-md-3">
            <label class="form-label">PO Number</label>
            <input type="text" class="form-control" formControlName="poNumber" readonly />
          </div>
          <div class="col-md-3">
            <label class="form-label">Date</label>
            <input type="date" class="form-control" formControlName="date" />
          </div>
          <div class="col-md-3">
            <label class="form-label">Expected Date</label>
            <input type="date" class="form-control" formControlName="expectedDate" />
          </div>
          <div class="col-md-3">
            <label class="form-label">Supplier</label>
            <select class="form-select" formControlName="supplierId">
              <option [ngValue]="null">Select supplier</option>
              <option *ngFor="let s of suppliers" [ngValue]="s.id">
                {{ s.name }}
              </option>
            </select>
          </div>
        </div>

        <div formArrayName="items" class="table-responsive mb-3">
          <table class="table table-bordered align-middle">
            <thead class="table-light">
              <tr>
                <th>Product</th>
                <th width="120">Cost</th>
                <th width="100">Qty</th>
                <th width="120">Total</th>
                <th width="60"></th>
              </tr>
            </thead>
            <tbody>
              <tr
                *ngFor="let item of items.controls; let i = index"
                [formGroupName]="i"
              >
                <td>
                  <select
                    class="form-select"
                    formControlName="productId"
                    (change)="onProductChange(i)"
                  >
                    <option [ngValue]="null">Select product</option>
                    <option *ngFor="let p of products" [ngValue]="p.id">
                      {{ p.name }}
                    </option>
                  </select>
                </td>
                <td>
                  <input type="number" class="form-control" formControlName="cost" />
                </td>
                <td>
                  <input type="number" class="form-control" formControlName="qty" />
                </td>
                <td>{{ lineTotal(i) | number: '1.2-2' }}</td>
                <td>
                  <button
                    type="button"
                    class="btn btn-sm btn-danger"
                    (click)="removeItem(i)"
                    [disabled]="items.length === 1"
                  >
                    <i class="bi bi-x-lg"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>

          <button
            type="button"
            class="btn btn-outline-primary"
            (click)="addItem()"
          >
            + Add Item
          </button>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-3">
            <label class="form-label">Shipping</label>
            <input type="number" class="form-control" formControlName="shipping" />
          </div>
          <div class="col-md-3">
            <label class="form-label">Discount</label>
            <input type="number" class="form-control" formControlName="discount" />
          </div>
          <div class="col-md-3">
            <label class="form-label">Tax (%)</label>
            <input type="number" class="form-control" formControlName="taxRate" />
          </div>
          <div class="col-md-3">
            <label class="form-label">Notes</label>
            <textarea class="form-control" formControlName="notes"></textarea>
          </div>
        </div>

        <div class="border-top pt-3">
          <div class="d-flex justify-content-end">
            <table class="table table-sm w-auto text-end">
              <tr><th>Subtotal:</th><td>{{ subtotal | number: '1.2-2' }}</td></tr>
              <tr><th>Shipping:</th><td>{{ shipping | number: '1.2-2' }}</td></tr>
              <tr><th>Discount:</th><td>-{{ discount | number: '1.2-2' }}</td></tr>
              <tr>
                <th>Tax ({{ form.get('taxRate')?.value }}%):</th>
                <td>{{ taxAmount | number: '1.2-2' }}</td>
              </tr>
              <tr class="fw-bold border-top">
                <th>Grand Total:</th>
                <td>{{ grandTotal | number: '1.2-2' }}</td>
              </tr>
            </table>
          </div>
        </div>

        <div class="text-end mt-3">
          <button type="submit" class="btn btn-success px-4 me-2">
            Save Purchase
          </button>
          <button
            type="button"
            class="btn btn-secondary px-4"
            (click)="resetForm()"
          >
            Reset
          </button>
        </div>
      </div>
    </div>
  </form>
</div>
